<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>New Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Planning Journey</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 30px;
        }

        /* Progress Tracker */
        .progress-tracker {
            width: 280px;
            background: white;
            border-radius: 15px;
            padding: 25px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: 90vh;
            overflow-y: auto;
        }

        .client-info-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .divider {
            height: 1px;
            background: #e0e0e0;
            margin: 20px 0;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
        }

        .action-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .save-btn {
            background: #4CAF50;
            color: white;
        }

        .save-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .export-btn {
            background: #2196F3;
            color: white;
        }

        .export-btn:hover {
            background: #0b7dda;
            transform: translateY(-2px);
        }

        .import-btn {
            background: #FF9800;
            color: white;
        }

        .import-btn:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .progress-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .progress-bar-container {
            background: #e9ecef;
            height: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .progress-percentage {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .progress-percentage br {
            display: block;
            content: "";
            margin-top: 5px;
        }

        .progress-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .progress-item:hover {
            background: #f8f9fa;
        }

        .progress-item.completed {
            background: #e8f5e9;
        }

        .progress-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .progress-checkbox.checked::after {
            content: "‚úì";
            color: #4CAF50;
            font-weight: bold;
            font-size: 14px;
        }

        .progress-label {
            font-size: 14px;
            color: #495057;
        }

        /* Flowchart Area */
        .flowchart-area {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .flowchart-title {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 40px;
            text-align: center;
        }

        .flowchart {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .flow-container-horizontal {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 60px;
            justify-content: center;
        }

        .branch-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .side-branch-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .branch-split {
            display: flex;
            align-items: flex-start;
            gap: 30px;
            margin-top: 0;
            width: 100%;
            justify-content: center;
        }

        .horizontal-arrow {
            font-size: 40px;
            color: #3498db;
            margin-top: 20px;
            font-weight: bold;
        }

        .side-branch {
            border-left: 3px solid #3498db;
            padding-left: 30px;
        }

        .flow-node {
            background: white;
            border: 3px solid #3498db;
            border-radius: 12px;
            padding: 25px 40px;
            min-width: 280px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .flow-node:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            border-color: #2980b9;
        }

        .flow-node.completed {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #4CAF50;
        }

        .flow-node-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .flow-node-subtitle {
            font-size: 14px;
            color: #7f8c8d;
        }

        .flow-node-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .node-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-notes {
            background: #3498db;
            color: white;
        }

        .btn-notes:hover {
            background: #2980b9;
        }

        .btn-link {
            background: #95a5a6;
            color: white;
        }

        .btn-link:hover {
            background: #7f8c8d;
        }

        .btn-complete {
            background: #4CAF50;
            color: white;
        }

        .btn-complete:hover {
            background: #45a049;
        }

        .btn-incomplete {
            background: #e74c3c;
            color: white;
        }

        .btn-incomplete:hover {
            background: #c0392b;
        }

        .flow-arrow {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #3498db;
            margin: 10px 0;
        }

        .flow-row {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .flow-horizontal-arrow {
            font-size: 30px;
            color: #3498db;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }

        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .close:hover {
            transform: scale(1.2);
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }

        select.form-input {
            cursor: pointer;
        }

        textarea.form-input {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        .modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-save {
            padding: 12px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-save:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-cancel {
            padding: 12px 30px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #7f8c8d;
        }

        .completion-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #4CAF50;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
        }

        .file-count-badge {
            position: absolute;
            top: -10px;
            left: -10px;
            background: #2196F3;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.4);
        }

        .file-upload-hint {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }

        .no-files {
            text-align: center;
            color: #95a5a6;
            padding: 20px;
            font-style: italic;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .file-icon {
            font-size: 24px;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .file-meta {
            font-size: 12px;
            color: #7f8c8d;
        }

        .file-actions {
            display: flex;
            gap: 5px;
        }

        .file-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .view-btn {
            background: #3498db;
            color: white;
        }

        .view-btn:hover {
            background: #2980b9;
        }

        .download-btn {
            background: #27ae60;
            color: white;
        }

        .download-btn:hover {
            background: #229954;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .main-flow-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .progress-tracker {
                width: 100%;
                position: relative;
                top: 0;
            }

            .flow-container-horizontal {
                flex-direction: column;
                gap: 30px;
            }

            .file-actions {
                flex-direction: column;
            }

            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .flow-row {
                flex-direction: column;
            }

            .flow-horizontal-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Progress Tracker -->
        <div class="progress-tracker">
            <div class="client-info-section">
                <h3 class="section-title">Client Information</h3>
                <div class="form-group">
                    <label class="form-label">Client Name</label>
                    <input type="text" class="form-input" id="clientName" placeholder="Enter client name">
                </div>
                <div class="form-group" id="clientName2Group" style="display: none;">
                    <label class="form-label">Client Name 2</label>
                    <input type="text" class="form-input" id="clientName2" placeholder="Enter second client name">
                </div>
                <div class="form-group">
                    <label class="form-label">Client Type</label>
                    <select class="form-input" id="clientType">
                        <option value="individual">Individual</option>
                        <option value="couple">Couple</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="clientDate">
                </div>
            </div>

            <div class="divider"></div>

            <div class="progress-header">Journey Progress</div>
            <div class="progress-percentage">üöÄ<br>0%</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill"></div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn save-btn" id="saveProgressBtn">üíæ Save Progress</button>
                <button class="action-btn export-btn" id="exportBtn">üì§ Export</button>
                <button class="action-btn import-btn" id="importBtn">üì• Import</button>
                <input type="file" id="importFile" accept=".json" style="display: none;">
            </div>

            <div class="divider"></div>

            <div id="progressList"></div>
        </div>

        <!-- Flowchart -->
        <div class="flowchart-area">
            <h1 class="flowchart-title">Financial Planning Journey</h1>
            <div class="flowchart" id="flowchart"></div>
        </div>
    </div>

    <!-- Modal -->
    <div id="notesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Add Notes</span>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">External Link (Optional)</label>
                    <input type="url" class="form-input" id="externalLink" placeholder="https://example.com/resource">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="notesText" placeholder="Add notes for this step..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Upload Files (PDF, Excel, Images)</label>
                    <input type="file" class="form-input" id="fileUpload" multiple accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png,.gif">
                    <div class="file-upload-hint">You can upload multiple files at once</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Uploaded Files</label>
                    <div id="fileList" class="file-list"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="cancelBtn">Cancel</button>
                <button class="btn-save" id="saveBtn">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Data structure for flowchart
        const flowData = [
            {
                id: 'cashflow-worksheet',
                title: 'Cashflow Worksheet',
                subtitle: 'In + Out',
                completed: false,
                notes: '',
                link: '',
                branch: 'main',
                files: []
            },
            {
                id: 'your-radius',
                title: 'Your Radius',
                subtitle: 'Where We Are Going',
                completed: false,
                notes: '',
                link: '',
                branch: 'main',
                files: []
            },
            {
                id: 'risk-radius',
                title: 'Risk Radius‚Ñ¢',
                subtitle: 'How & Why?',
                completed: false,
                notes: '',
                link: '',
                branch: 'main',
                files: []
            },
            {
                id: 'efficiency-matrix',
                title: 'Efficiency Matrix',
                subtitle: 'Risk/Tax Distribution Magic',
                completed: false,
                notes: '',
                link: '',
                branch: 'main',
                files: []
            },
            {
                id: 'cashflow-engine',
                title: 'Cashflow Engine',
                subtitle: 'Find Your Zero - Where Money Should Flow',
                completed: false,
                notes: '',
                link: '',
                branch: 'side',
                files: []
            },
            {
                id: '5-year-journey',
                title: '5 Year Journey',
                subtitle: 'Portfolio Trajectory',
                completed: false,
                notes: '',
                link: '',
                branch: 'side',
                files: []
            },
            {
                id: 'annual-report',
                title: 'Annual Report',
                subtitle: '',
                completed: false,
                notes: '',
                link: '',
                branch: 'side',
                files: []
            },
            {
                id: 'distribution-qs',
                title: 'Distribution Q\'s',
                subtitle: 'When Needed',
                completed: false,
                notes: '',
                link: '',
                branch: 'side',
                files: []
            }
        ];

        // Client information
        let clientInfo = {
            name: '',
            name2: '',
            clientType: 'individual',
            date: new Date().toISOString().split('T')[0]
        };

        let currentNodeId = null;

        // Load saved data from localStorage
        function loadSavedData() {
            const saved = localStorage.getItem('financialFlowData');
            if (saved) {
                const savedData = JSON.parse(saved);
                savedData.forEach((savedNode, index) => {
                    if (flowData[index]) {
                        flowData[index].completed = savedNode.completed;
                        flowData[index].notes = savedNode.notes;
                        flowData[index].link = savedNode.link;
                        flowData[index].files = savedNode.files || [];
                    }
                });
            }
            
            const savedClient = localStorage.getItem('clientInfo');
            if (savedClient) {
                clientInfo = JSON.parse(savedClient);
                document.getElementById('clientName').value = clientInfo.name;
                document.getElementById('clientName2').value = clientInfo.name2 || '';
                document.getElementById('clientType').value = clientInfo.clientType;
                document.getElementById('clientDate').value = clientInfo.date;
                toggleClientName2Visibility();
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('financialFlowData', JSON.stringify(flowData));
            localStorage.setItem('clientInfo', JSON.stringify(clientInfo));
        }

        // Save client info
        function saveClientInfo() {
            clientInfo.name = document.getElementById('clientName').value;
            clientInfo.name2 = document.getElementById('clientName2').value;
            clientInfo.clientType = document.getElementById('clientType').value;
            clientInfo.date = document.getElementById('clientDate').value;
            toggleClientName2Visibility();
            saveData();
        }

        // Toggle second client name field visibility
        function toggleClientName2Visibility() {
            const name2Group = document.getElementById('clientName2Group');
            if (clientInfo.clientType === 'couple') {
                name2Group.style.display = 'block';
            } else {
                name2Group.style.display = 'none';
            }
        }

        // Initialize
        function init() {
            loadSavedData();
            renderFlowchart();
            renderProgressTracker();
            updateProgress();
            setupModalHandlers();
        }

        // Render flowchart
        function renderFlowchart() {
            const flowchart = document.getElementById('flowchart');
            flowchart.innerHTML = '';

            // Main branch nodes
            const mainBranch = flowData.filter(node => node.branch === 'main');
            const sideBranch = flowData.filter(node => node.branch === 'side');

            const flowContainer = document.createElement('div');
            flowContainer.className = 'flow-container-horizontal';

            // Create main branch
            const mainContainer = document.createElement('div');
            mainContainer.className = 'branch-container';
            
            mainBranch.forEach((node, index) => {
                const nodeDiv = createNodeElement(node);
                mainContainer.appendChild(nodeDiv);

                // Add arrow after all nodes except the last
                if (index < mainBranch.length - 1) {
                    const arrow = document.createElement('div');
                    arrow.className = 'flow-arrow';
                    mainContainer.appendChild(arrow);
                }
            });

            flowContainer.appendChild(mainContainer);

            // Create side branch next to main branch
            if (sideBranch.length > 0) {
                const sideContainer = document.createElement('div');
                sideContainer.className = 'branch-container side-branch-container';
                
                sideBranch.forEach((node, index) => {
                    const nodeDiv = createNodeElement(node);
                    sideContainer.appendChild(nodeDiv);

                    if (index < sideBranch.length - 1) {
                        const arrow = document.createElement('div');
                        arrow.className = 'flow-arrow';
                        sideContainer.appendChild(arrow);
                    }
                });

                flowContainer.appendChild(sideContainer);
            }

            flowchart.appendChild(flowContainer);
        }

        // Create node element
        function createNodeElement(node) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = `flow-node ${node.completed ? 'completed' : ''}`;
            nodeDiv.id = node.id;

            const fileCount = node.files ? node.files.length : 0;
            const fileIndicator = fileCount > 0 ? `<span class="file-count-badge">${fileCount} üìé</span>` : '';

            nodeDiv.innerHTML = `
                ${node.completed ? '<div class="completion-badge">‚úì</div>' : ''}
                ${fileIndicator}
                <div class="flow-node-title">${node.title}</div>
                ${node.subtitle ? `<div class="flow-node-subtitle">${node.subtitle}</div>` : ''}
                <div class="flow-node-buttons">
                    <button class="node-btn btn-notes" onclick="openNotesModal('${node.id}')">üìù Notes</button>
                    ${node.link ? `<button class="node-btn btn-link" onclick="window.open('${node.link}', '_blank')">üîó Link</button>` : ''}
                    <button class="node-btn ${node.completed ? 'btn-incomplete' : 'btn-complete'}" onclick="toggleComplete('${node.id}')">
                        ${node.completed ? '‚Ü©Ô∏è Undo' : '‚úì Complete'}
                    </button>
                </div>
            `;

            return nodeDiv;
        }

        // Render progress tracker
        function renderProgressTracker() {
            const progressList = document.getElementById('progressList');
            progressList.innerHTML = '';

            flowData.forEach(node => {
                const item = document.createElement('div');
                item.className = `progress-item ${node.completed ? 'completed' : ''}`;
                item.onclick = () => scrollToNode(node.id);

                item.innerHTML = `
                    <div class="progress-checkbox ${node.completed ? 'checked' : ''}"></div>
                    <div class="progress-label">${node.title}</div>
                `;

                progressList.appendChild(item);
            });
        }

        // Update progress percentage
        function updateProgress() {
            const completedCount = flowData.filter(node => node.completed).length;
            const percentage = Math.round((completedCount / flowData.length) * 100);
            const emoji = getProgressEmoji();

            document.querySelector('.progress-percentage').innerHTML = `${emoji}<br>${percentage}%`;
            document.querySelector('.progress-bar-fill').style.width = `${percentage}%`;
        }

        // Scroll to node
        function scrollToNode(nodeId) {
            const element = document.getElementById(nodeId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 300);
            }
        }

        // Toggle completion status
        function toggleComplete(nodeId) {
            const node = flowData.find(n => n.id === nodeId);
            if (node) {
                node.completed = !node.completed;
                saveData();
                renderFlowchart();
                renderProgressTracker();
                updateProgress();
            }
        }

        // Open notes modal
        function openNotesModal(nodeId) {
            currentNodeId = nodeId;
            const node = flowData.find(n => n.id === nodeId);

            if (node) {
                document.getElementById('modalTitle').textContent = node.title;
                document.getElementById('notesText').value = node.notes || '';
                document.getElementById('externalLink').value = node.link || '';
                renderFileList();
                document.getElementById('notesModal').style.display = 'block';
            }
        }

        // Close notes modal
        function closeNotesModal() {
            document.getElementById('notesModal').style.display = 'none';
            currentNodeId = null;
        }

        // Save notes
        function saveNotes() {
            if (currentNodeId) {
                const node = flowData.find(n => n.id === currentNodeId);
                if (node) {
                    node.notes = document.getElementById('notesText').value;
                    node.link = document.getElementById('externalLink').value;
                    saveData();
                    renderFlowchart();
                    closeNotesModal();
                }
            }
        }

        // Handle file upload
        function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0 || !currentNodeId) return;

            const node = flowData.find(n => n.id === currentNodeId);
            if (!node) return;

            if (!node.files) node.files = [];

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    node.files.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        uploadDate: new Date().toISOString()
                    });
                    saveData();
                    renderFileList();
                    renderFlowchart();
                };
                reader.readAsDataURL(file);
            });

            event.target.value = '';
        }

        // Render file list in modal
        function renderFileList() {
            const fileListContainer = document.getElementById('fileList');
            if (!currentNodeId) return;

            const node = flowData.find(n => n.id === currentNodeId);
            if (!node || !node.files || node.files.length === 0) {
                fileListContainer.innerHTML = '<p class="no-files">No files uploaded yet</p>';
                return;
            }

            fileListContainer.innerHTML = node.files.map((file, index) => `
                <div class="file-item">
                    <div class="file-info">
                        <span class="file-icon">${getFileIcon(file.type)}</span>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-meta">${formatFileSize(file.size)} ‚Ä¢ ${new Date(file.uploadDate).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="file-btn view-btn" onclick="viewFile(${index})">üëÅÔ∏è View</button>
                        <button class="file-btn download-btn" onclick="downloadFile(${index})">‚¨áÔ∏è Download</button>
                        <button class="file-btn delete-btn" onclick="deleteFile(${index})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Get file icon based on type
        function getFileIcon(type) {
            if (type.includes('pdf')) return 'üìÑ';
            if (type.includes('image')) return 'üñºÔ∏è';
            if (type.includes('excel') || type.includes('spreadsheet')) return 'üìä';
            if (type.includes('word') || type.includes('document')) return 'üìù';
            return 'üìé';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // View file
        function viewFile(fileIndex) {
            if (!currentNodeId) return;
            const node = flowData.find(n => n.id === currentNodeId);
            if (!node || !node.files[fileIndex]) return;

            const file = node.files[fileIndex];
            const newWindow = window.open();
            
            if (file.type.includes('image')) {
                newWindow.document.write(`<img src="${file.data}" style="max-width:100%;">`);
            } else if (file.type.includes('pdf')) {
                newWindow.document.write(`<iframe src="${file.data}" width="100%" height="100%" style="border:none;"></iframe>`);
            } else {
                // For other file types, trigger download
                downloadFile(fileIndex);
                newWindow.close();
            }
        }

        // Download file
        function downloadFile(fileIndex) {
            if (!currentNodeId) return;
            const node = flowData.find(n => n.id === currentNodeId);
            if (!node || !node.files[fileIndex]) return;

            const file = node.files[fileIndex];
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            link.click();
        }

        // Delete file
        function deleteFile(fileIndex) {
            if (!currentNodeId) return;
            if (!confirm('Are you sure you want to delete this file?')) return;

            const node = flowData.find(n => n.id === currentNodeId);
            if (!node || !node.files[fileIndex]) return;

            node.files.splice(fileIndex, 1);
            saveData();
            renderFileList();
            renderFlowchart();
        }

        // Setup modal handlers
        function setupModalHandlers() {
            document.querySelector('.close').onclick = closeNotesModal;
            document.getElementById('cancelBtn').onclick = closeNotesModal;
            document.getElementById('saveBtn').onclick = saveNotes;

            window.onclick = function(event) {
                const modal = document.getElementById('notesModal');
                if (event.target === modal) {
                    closeNotesModal();
                }
            };

            // File upload handler
            document.getElementById('fileUpload').addEventListener('change', handleFileUpload);

            // Client info handlers
            document.getElementById('clientName').addEventListener('input', saveClientInfo);
            document.getElementById('clientName2').addEventListener('input', saveClientInfo);
            document.getElementById('clientType').addEventListener('change', saveClientInfo);
            document.getElementById('clientDate').addEventListener('change', saveClientInfo);

            // Save progress button
            document.getElementById('saveProgressBtn').onclick = function() {
                saveData();
                alert('Progress saved successfully!');
            };

            // Export button
            document.getElementById('exportBtn').onclick = function() {
                const exportData = {
                    flowData: flowData,
                    clientInfo: clientInfo,
                    exportDate: new Date().toISOString()
                };
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const clientNames = clientInfo.clientType === 'couple' && clientInfo.name2
                    ? `${clientInfo.name.replace(/\s+/g, '-')}-${clientInfo.name2.replace(/\s+/g, '-')}`
                    : clientInfo.name.replace(/\s+/g, '-') || 'export';
                link.download = `financial-plan-${clientNames}-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            // Import button
            document.getElementById('importBtn').onclick = function() {
                document.getElementById('importFile').click();
            };

            document.getElementById('importFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const importData = JSON.parse(event.target.result);
                            if (importData.flowData && importData.clientInfo) {
                                importData.flowData.forEach((node, index) => {
                                    if (flowData[index]) {
                                        flowData[index].completed = node.completed;
                                        flowData[index].notes = node.notes;
                                        flowData[index].link = node.link;
                                        flowData[index].files = node.files || [];
                                    }
                                });
                                clientInfo = importData.clientInfo;
                                saveData();
                                location.reload();
                            } else {
                                alert('Invalid file format');
                            }
                        } catch (error) {
                            alert('Error importing file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
                e.target.value = '';
            });
        }

        // Get progress emoji based on completion
        function getProgressEmoji() {
            const percentage = getProgressPercentage();
            if (percentage === 0) return 'üöÄ'; // Starting
            if (percentage < 25) return 'üòä'; // Just started
            if (percentage < 50) return 'üòÑ'; // Making progress
            if (percentage < 75) return 'üéâ'; // Good progress
            if (percentage < 100) return 'üåü'; // Almost there
            return 'üèÜ'; // Complete!
        }

        function getProgressPercentage() {
            const completedCount = flowData.filter(node => node.completed).length;
            return Math.round((completedCount / flowData.length) * 100);
        }

        // Initialize on page load
        window.onload = init;
    </script>
</body>
</html>
